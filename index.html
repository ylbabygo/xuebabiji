<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>51Talk ç¦åˆ©å¤§æ”¾é€ï¼å°å­¦è‹±è¯­å­¦éœ¸ç¬”è®°ã€å…è´¹é¢†å–ã€‘</title>
    <meta name="description" content="51Talkå…è´¹èµ é€å°å­¦è‹±è¯­å­¦éœ¸ç¬”è®°ï¼Œè¦†ç›–å„å¤§æ•™æç‰ˆæœ¬ï¼Œåå¸ˆæ•´ç†ï¼Œå¸®åŠ©å­©å­è½»æ¾æŒæ¡é«˜åˆ†æŠ€å·§ï¼">

    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">

    <!-- é™åˆ¶æç¤ºæ ·å¼ -->
    <style>
        .restriction-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.2);
            animation: slideDown 0.3s ease-out;
        }

        .restriction-content {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .restriction-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .restriction-message h4 {
            margin: 0 0 8px 0;
            color: #d35400;
            font-weight: 700;
            font-size: 18px;
        }

        .restriction-message p {
            margin: 4px 0;
            color: #7d6608;
            line-height: 1.4;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .version-card.disabled {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .version-card.disabled:hover {
            transform: none !important;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.2) !important;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Header Banner -->
        <header class="header-banner" role="banner">
            <div class="banner-content">
                <img src="assets/51Talk.png" alt="51Talk Logo" class="logo">
                <h1 class="main-title">51Talk ç¦åˆ©å¤§æ”¾é€ï¼</h1>
                <h2 class="subtitle">å°å­¦è‹±è¯­å­¦éœ¸ç¬”è®°ã€å…è´¹é¢†å–ã€‘</h2>
            </div>
            <div class="banner-decoration"></div>
        </header>

        <!-- Value Proposition Section -->
        <section class="value-section" aria-label="èµ„æ–™ä»·å€¼è¯´æ˜">
            <div class="value-content">
                <h3 class="value-title">ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬çš„å­¦éœ¸ç¬”è®°ï¼Ÿ</h3>
                <div class="value-points">
                    <div class="value-point">
                        <span class="value-icon">ğŸ‘¨â€ğŸ«</span>
                        <p>ç”±51Talké‡‘ç‰Œæ•™ç ”å›¢é˜Ÿå€¾åŠ›æ‰“é€ </p>
                    </div>
                    <div class="value-point">
                        <span class="value-icon">ğŸ“š</span>
                        <p>ç´§è´´è¯¾å ‚æ•™æï¼Œè¦†ç›–å…¨éƒ¨æ ¸å¿ƒçŸ¥è¯†ç‚¹</p>
                    </div>
                    <div class="value-point">
                        <span class="value-icon">ğŸ¯</span>
                        <p>å›¾æ–‡å¹¶èŒ‚ï¼Œè®©å­©å­å‘Šåˆ«æ­»è®°ç¡¬èƒŒ</p>
                    </div>
                    <div class="value-point">
                        <span class="value-icon">ğŸ“ˆ</span>
                        <p>è½»æ¾æŒæ¡é«˜åˆ†æŠ€å·§ï¼Œæˆç»©å¿«é€Ÿæå‡</p>
                    </div>
                </div>
              </div>
        </section>

        <!-- Version Selection Section -->
        <section class="selection-section" aria-label="æ•™æç‰ˆæœ¬é€‰æ‹©">
            <h3 class="selection-title">è¯·æ ¹æ®å­©å­çš„æ•™æï¼Œé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬</h3>

            <div class="versions-grid" role="group" aria-label="æ•™æç‰ˆæœ¬é€‰é¡¹" id="versionsGrid">
                <!-- Version cards will be generated by JavaScript -->
            </div>

            <div class="selection-hint">
                <p>ğŸ’¡ æç¤ºï¼šè¯·ä»”ç»†ç¡®è®¤å­©å­ä½¿ç”¨çš„æ•™æç‰ˆæœ¬ï¼Œé€‰æ‹©æ­£ç¡®çš„ç‰ˆæœ¬é¢†å–</p>
            </div>
        </section>

        <!-- Claim Button (Fixed CTA) -->
        <div class="claim-button-container">
            <button
                type="button"
                id="claimButton"
                class="claim-button"
                disabled
                aria-label="ç«‹å³å…è´¹é¢†å–æŒ‰é’®"
            >
                <span class="button-text">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬</span>
                <span class="button-spinner" aria-hidden="true"></span>
            </button>
        </div>

        <!-- Footer -->
        <footer class="footer" role="contentinfo">
            <div class="footer-content">
                <img src="assets/51Talk.png" alt="51Talk Logo" class="footer-logo">
                <p class="copyright">Â© 2024 51Talk. All rights reserved.</p>
                <p class="company-info">51Talk æ˜¯ä¸­å›½é¢†å…ˆçš„åœ¨çº¿å°‘å„¿è‹±è¯­æ•™è‚²å¹³å°</p>
            </div>
        </footer>
    </div>

        <!-- Success Modal -->
        <div
            id="successModal"
            class="modal"
            role="dialog"
            aria-labelledby="modalTitle"
            aria-modal="true"
            hidden
        >
            <div class="modal-backdrop" aria-hidden="true"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle" class="modal-title">ğŸ‰ é¢†å–æˆåŠŸï¼å¿«å»ä¿å­˜å§ï¼</h3>
                    <button
                        type="button"
                        class="modal-close"
                        aria-label="å…³é—­å¼¹çª—"
                        id="modalClose"
                    >
                        Ã—
                    </button>
                </div>
                <div class="modal-body">
                    <div class="claim-info">
                        <p class="claim-version"><strong>æ‚¨é¢†å–çš„ç‰ˆæœ¬ï¼š</strong><span id="claimedVersion"></span></p>
                        <div class="link-section">
                            <p class="link-label"><strong>ç™¾åº¦ç½‘ç›˜é“¾æ¥ï¼š</strong></p>
                            <div class="link-container">
                                <input
                                    type="text"
                                    id="linkInput"
                                    readonly
                                    aria-label="ç™¾åº¦ç½‘ç›˜é“¾æ¥"
                                >
                                <button
                                    type="button"
                                    class="copy-button"
                                    id="copyLink"
                                    aria-label="å¤åˆ¶é“¾æ¥"
                                >
                                    å¤åˆ¶é“¾æ¥
                                </button>
                            </div>
                        </div>
                        <div class="code-section">
                            <p class="code-label"><strong>æå–ç ï¼š</strong></p>
                            <div class="code-container">
                                <span class="extraction-code" id="extractionCode">talk</span>
                                <button
                                    type="button"
                                    class="copy-button"
                                    id="copyCode"
                                    aria-label="å¤åˆ¶æå–ç "
                                >
                                    å¤åˆ¶æå–ç 
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="primary-button" id="openLink">
                            ç«‹å³æ‰“å¼€ç½‘ç›˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Toast -->
        <div
            id="errorToast"
            class="toast"
            role="alert"
            aria-live="assertive"
            hidden
        >
            <span class="toast-message" id="errorMessage"></span>
            <button
                type="button"
                class="toast-close"
                aria-label="å…³é—­æç¤º"
                id="toastClose"
            >
                Ã—
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ç‰ˆæœ¬æ•°æ®
        const VERSIONS_DATA = {
            'äººæ•™ç‰ˆÂ·ä¸€èµ·ç‚¹': {
                id: 'pep-together',
                link: 'https://pan.baidu.com/s/1tCTnBVJR27pGb5lBnfNJCg?pwd=talk',
                code: 'talk'
            },
            'äººæ•™ç‰ˆÂ·ä¸‰èµ·ç‚¹': {
                id: 'pep-three',
                link: 'https://pan.baidu.com/s/1VxtrXNOoqeI-jyNl3VYucw?pwd=talk',
                code: 'talk'
            },
            'åŒ—å¸ˆå¤§ç‰ˆ': {
                id: 'bnu',
                link: 'https://pan.baidu.com/s/1ehElAltU7dL9OT4K3lU3vw?pwd=talk',
                code: 'talk'
            },
            'å†€æ•™ç‰ˆÂ·ä¸€èµ·ç‚¹': {
                id: 'jijiao-together',
                link: 'https://pan.baidu.com/s/1OeLc_dnwdaU0TCEyM6-Ffg?pwd=talk',
                code: 'talk'
            },
            'å†€æ•™ç‰ˆÂ·ä¸‰èµ·ç‚¹': {
                id: 'jijiao-three',
                link: 'https://pan.baidu.com/s/154u1tF-YzzOXqMmWZHpDRg?pwd=talk',
                code: 'talk'
            },
            'å¤–ç ”ç¤¾Â·ä¸€èµ·ç‚¹': {
                id: 'fltrp-together',
                link: 'https://pan.baidu.com/s/1girOir1Mx_pNOeQbc4i-iQ?pwd=talk',
                code: 'talk'
            },
            'å¤–ç ”ç¤¾Â·ä¸‰èµ·ç‚¹': {
                id: 'fltrp-three',
                link: 'https://pan.baidu.com/s/1ByBQ9O6tnX7bTwOifFq7Jg?pwd=talk',
                code: 'talk'
            },
            'è¯‘æ—ç‰ˆ': {
                id: 'yilin',
                link: 'https://pan.baidu.com/s/1Vs2yD0438JUPvmMOK5F89w?pwd=talk',
                code: 'talk'
            },
            'æ²ªæ•™ç‰ˆ': {
                id: 'shangjiao',
                link: 'https://pan.baidu.com/s/1H97VszvcHAaSTJlPLlGMbA?pwd=talk',
                code: 'talk'
            }
        };

        // åº”ç”¨çŠ¶æ€
        let selectedVersion = null;
        let isProcessing = false;
        let claimInfo = null;

        // å­˜å‚¨ç®¡ç†
        const StorageManager = {
            STORAGE_KEY: '51talk_claim_info',
            THIRTY_DAYS_IN_MS: 30 * 24 * 60 * 60 * 1000,

            getClaimInfo() {
                try {
                    const stored = localStorage.getItem(this.STORAGE_KEY);
                    if (!stored) return null;
                    return JSON.parse(stored);
                } catch (error) {
                    console.warn('è¯»å–é¢†å–ä¿¡æ¯å¤±è´¥:', error);
                    return null;
                }
            },

            setClaimInfo(version, ipAddress) {
                try {
                    const claimInfo = {
                        version: version,
                        claimedAt: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + this.THIRTY_DAYS_IN_MS).toISOString(),
                        ipAddress: ipAddress,
                        deviceFingerprint: this.generateDeviceFingerprint()
                    };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(claimInfo));
                    return claimInfo;
                } catch (error) {
                    console.error('ä¿å­˜é¢†å–ä¿¡æ¯å¤±è´¥:', error);
                    return null;
                }
            },

            hasValidClaim() {
                const claimInfo = this.getClaimInfo();
                if (!claimInfo) return false;
                const now = new Date();
                const expiryDate = new Date(claimInfo.expiresAt);
                return now < expiryDate;
            },

            getRemainingDays() {
                const claimInfo = this.getClaimInfo();
                if (!claimInfo) return 0;
                const now = new Date();
                const expiryDate = new Date(claimInfo.expiresAt);
                const diffMs = expiryDate - now;
                return Math.max(0, Math.ceil(diffMs / (24 * 60 * 60 * 1000)));
            },

            generateDeviceFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);

                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    canvas.toDataURL()
                ].join('|');

                let hash = 0;
                for (let i = 0; i < fingerprint.length; i++) {
                    const char = fingerprint.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            },

            clearClaimInfo() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                } catch (error) {
                    console.warn('æ¸…é™¤é¢†å–ä¿¡æ¯å¤±è´¥:', error);
                }
            }
        };

        // é™åˆ¶ç®¡ç†
        const RestrictionManager = {
            CLAIM_ATTEMPTS_KEY: '51talk_claim_attempts',
            MAX_ATTEMPTS_PER_PERIOD: 3,
            ATTEMPT_WINDOW_MS: 60 * 60 * 1000, // 1å°æ—¶

            getClaimAttempts() {
                try {
                    const stored = sessionStorage.getItem(this.CLAIM_ATTEMPTS_KEY);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    return [];
                }
            },

            addClaimAttempt() {
                const attempts = this.getClaimAttempts();
                const now = Date.now();

                // æ¸…ç†è¿‡æœŸè®°å½•
                const validAttempts = attempts.filter(time =>
                    now - time < this.ATTEMPT_WINDOW_MS
                );

                validAttempts.push(now);
                sessionStorage.setItem(this.CLAIM_ATTEMPTS_KEY, JSON.stringify(validAttempts));
                return validAttempts;
            },

            isRateLimited() {
                const attempts = this.getClaimAttempts();
                const now = Date.now();
                const recentAttempts = attempts.filter(time =>
                    now - time < this.ATTEMPT_WINDOW_MS
                );
                return recentAttempts.length >= this.MAX_ATTEMPTS_PER_PERIOD;
            },

            getRemainingTime() {
                const attempts = this.getClaimAttempts();
                if (attempts.length === 0) return 0;

                const oldestAttempt = Math.min(...attempts);
                const resetTime = oldestAttempt + this.ATTEMPT_WINDOW_MS;
                return Math.max(0, resetTime - Date.now());
            }
        };

        // DOM å…ƒç´ 
        const elements = {
            versionsGrid: null,
            claimButton: null
        };

        // è·å–ç”¨æˆ· IP åœ°å€
        async function getUserIP() {
            try {
                // ä½¿ç”¨å…¬å…± IP æœåŠ¡
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('è·å– IP åœ°å€å¤±è´¥:', error);
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç”ŸæˆåŸºäº UserAgent çš„ä¼ª IP
                return '127.0.0.1';
            }
        }

        // æ£€æŸ¥é¢†å–é™åˆ¶
        async function checkClaimRestrictions() {
            // 1. æ£€æŸ¥è®¾å¤‡é™åˆ¶
            if (StorageManager.hasValidClaim()) {
                const claimInfo = StorageManager.getClaimInfo();
                return {
                    restricted: true,
                    reason: 'device',
                    message: `æ‚¨å·²åœ¨æœ¬è®¾å¤‡é¢†å–è¿‡èµ„æ–™ï¼Œè¯· ${StorageManager.getRemainingDays()} å¤©åå†è¯•ã€‚`,
                    claimInfo: claimInfo
                };
            }

            // 2. æ£€æŸ¥é¢‘ç‡é™åˆ¶
            if (RestrictionManager.isRateLimited()) {
                const remainingMinutes = Math.ceil(RestrictionManager.getRemainingTime() / (60 * 1000));
                return {
                    restricted: true,
                    reason: 'rate_limit',
                    message: `æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯· ${remainingMinutes} åˆ†é’Ÿåå†è¯•ã€‚`,
                    remainingTime: RestrictionManager.getRemainingTime()
                };
            }

            // 3. æ£€æŸ¥æœåŠ¡å™¨ç«¯é™åˆ¶ï¼ˆå¯é€‰ï¼Œç”¨äº IP é™åˆ¶ï¼‰
            try {
                const userIP = await getUserIP();
                const serverCheck = await checkServerRestriction(userIP);
                if (serverCheck.restricted) {
                    return serverCheck;
                }
            } catch (error) {
                console.warn('æœåŠ¡å™¨é™åˆ¶æ£€æŸ¥å¤±è´¥:', error);
            }

            return { restricted: false };
        }

        // æœåŠ¡å™¨ç«¯é™åˆ¶æ£€æŸ¥ï¼ˆä¸´æ—¶ç®€åŒ–ç‰ˆæœ¬ï¼Œé¿å… Edge Function CORS é—®é¢˜ï¼‰
        async function checkServerRestriction(ip) {
            try {
                console.log('æš‚æ—¶è·³è¿‡æœåŠ¡å™¨é™åˆ¶æ£€æŸ¥ï¼ˆEdge Function CORS é—®é¢˜ï¼‰');
                return { restricted: false };

                /*
                // åŸ Edge Function æ£€æŸ¥ä»£ç æš‚æ—¶ç¦ç”¨
                // TODO: éƒ¨ç½² Edge Function åæ¢å¤æ­¤åŠŸèƒ½

                // å¤šé‡ç¯å¢ƒå˜é‡è·å–æ–¹æ³•
                let supabaseUrl, supabaseKey;

                // æ–¹æ³• 1: Vercel ç¯å¢ƒå˜é‡
                if (typeof process !== 'undefined' && process.env) {
                    supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
                    supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
                    console.log('ä½¿ç”¨ process.env é…ç½®');
                }
                // æ–¹æ³• 2: window.ENV
                else if (typeof window !== 'undefined' && window.ENV && window.ENV.SUPABASE_URL) {
                    supabaseUrl = window.ENV.SUPABASE_URL;
                    supabaseKey = window.ENV.SUPABASE_ANON_KEY;
                    console.log('ä½¿ç”¨ window.ENV é…ç½®');
                }
                // æ–¹æ³• 3: ç¡¬ç¼–ç ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
                else {
                    supabaseUrl = 'https://ddttfkymbudozwkixdyg.supabase.co';
                    supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHRma3ltYnVkb3p3a2l4ZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzMxMzMsImV4cCI6MjA4MDE0OTEzM30.yjZTQQ4b_CCTXoLrnxJZ5bdPVuPYDHhihaD1Mr7RL9s';
                    console.log('ä½¿ç”¨ç¡¬ç¼–ç é…ç½®');
                }

                if (!supabaseUrl || !supabaseKey || supabaseUrl === 'YOUR_SUPABASE_URL') {
                    console.log('Supabase æœªé…ç½®ï¼Œè·³è¿‡æœåŠ¡å™¨é™åˆ¶');
                    return { restricted: false };
                }

                const response = await fetch(`${supabaseUrl}/functions/v1/validate-claim`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseKey}`
                    },
                    body: JSON.stringify({
                        version: 'check',
                        userAgent: navigator.userAgent,
                        deviceFingerprint: StorageManager.generateDeviceFingerprint(),
                        sessionId: sessionStorage.getItem('sessionId') || generateSessionId()
                    })
                });

                console.log('Supabase response status:', response.status);
                const responseText = await response.text();
                console.log('Supabase response:', responseText);

                if (!response.ok) {
                    try {
                        const errorData = JSON.parse(responseText);
                        return {
                            restricted: true,
                            reason: 'server_error',
                            message: errorData.error || 'æœåŠ¡å™¨éªŒè¯å¤±è´¥',
                            details: errorData
                        };
                    } catch (parseError) {
                        return {
                            restricted: true,
                            reason: 'server_error',
                            message: `æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${responseText}`,
                            details: { status: response.status, text: responseText }
                        };
                    }
                }

                const result = JSON.parse(responseText);
                return {
                    restricted: !result.success,
                    reason: result.type || null,
                    message: result.error || null,
                    details: result
                };
                */

            } catch (error) {
                console.warn('æœåŠ¡å™¨é™åˆ¶æ£€æŸ¥å¤±è´¥:', error);
                return { restricted: false };
            }
        }

        // æ˜¾ç¤ºé™åˆ¶ä¿¡æ¯
        function showRestrictionNotice(restriction) {
            const versionCards = document.querySelectorAll('.version-card');
            versionCards.forEach(card => {
                card.classList.add('disabled');
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            });

            elements.claimButton.disabled = true;
            elements.claimButton.querySelector('.button-text').textContent = restriction.message;

            // æ˜¾ç¤ºé™åˆ¶æç¤º
            const restrictionDiv = document.createElement('div');
            restrictionDiv.className = 'restriction-notice';
            restrictionDiv.innerHTML = `
                <div class="restriction-content">
                    <span class="restriction-icon">âš ï¸</span>
                    <div class="restriction-message">
                        <h4>é¢†å–é™åˆ¶</h4>
                        <p>${restriction.message}</p>
                        ${restriction.reason === 'device' ?
                            `<p>å¦‚éœ€å…¶ä»–ç‰ˆæœ¬ï¼Œè¯·æ›´æ¢è®¾å¤‡æˆ–è”ç³»å®¢æœã€‚</p>` : ''}
                    </div>
                </div>
            `;

            const selectionSection = document.querySelector('.selection-section');
            if (selectionSection) {
                selectionSection.insertBefore(restrictionDiv, selectionSection.querySelector('.versions-grid'));
            }
        }

        // è®°å½•é¢†å–æ•°æ®ï¼ˆç”¨äºç»Ÿè®¡åˆ†æï¼‰
        function recordClaimData(version, ipAddress, userAgent) {
            const claimData = {
                version: version,
                ipAddress: ipAddress,
                userAgent: userAgent,
                timestamp: new Date().toISOString(),
                deviceFingerprint: StorageManager.generateDeviceFingerprint(),
                sessionId: sessionStorage.getItem('sessionId') || generateSessionId()
            };

            // ä¿å­˜åˆ°æœ¬åœ°ç”¨äºç»Ÿè®¡
            try {
                const existingData = JSON.parse(localStorage.getItem('51talk_claim_statistics') || '[]');
                existingData.push(claimData);

                // åªä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•
                if (existingData.length > 100) {
                    existingData.splice(0, existingData.length - 100);
                }

                localStorage.setItem('51talk_claim_statistics', JSON.stringify(existingData));
            } catch (error) {
                console.warn('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }

            // å‘é€åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            sendClaimDataToServer(claimData);

            return claimData;
        }

        // ç”Ÿæˆä¼šè¯ ID
        function generateSessionId() {
            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('sessionId', sessionId);
            return sessionId;
        }

        // å‘é€ç»Ÿè®¡æ•°æ®åˆ°æœåŠ¡å™¨
        function sendClaimDataToServer(data) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å‘ä½ çš„æœåŠ¡å™¨å‘é€æ•°æ®çš„é€»è¾‘
            // ä¾‹å¦‚å‘é€åˆ° Google Analytics, ç™¾åº¦ç»Ÿè®¡, æˆ–è‡ªå·±çš„åˆ†ææœåŠ¡å™¨
            console.log('ç»Ÿè®¡æ•°æ®:', data);

            // ç¤ºä¾‹ï¼šå‘é€åˆ° Google Analytics 4ï¼ˆå¦‚æœå·²é…ç½®ï¼‰
            if (typeof gtag !== 'undefined') {
                gtag('event', 'claim_success', {
                    version: data.version,
                    device_fingerprint: data.deviceFingerprint
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');

            // è·å– DOM å…ƒç´ 
            elements.versionsGrid = document.getElementById('versionsGrid');
            elements.claimButton = document.getElementById('claimButton');

            if (!elements.versionsGrid || !elements.claimButton) {
                console.error('æ‰¾ä¸åˆ°å¿…éœ€çš„ DOM å…ƒç´ ');
                return;
            }

            // æ£€æŸ¥é¢†å–é™åˆ¶
            checkClaimRestrictions().then(restriction => {
                if (restriction.restricted) {
                    showRestrictionNotice(restriction);
                    console.log('é¢†å–å—é™:', restriction);
                } else {
                    console.log('æ— é™åˆ¶ï¼Œæ­£å¸¸åˆå§‹åŒ–');
                }

                // æ— è®ºæ˜¯å¦å—é™éƒ½åˆå§‹åŒ–ç‰ˆæœ¬å¡ç‰‡
                initializeVersions();
                setupEventListeners();
            });

            console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–ç‰ˆæœ¬å¡ç‰‡
        function initializeVersions() {
            const versions = Object.keys(VERSIONS_DATA);
            console.log('å¯ç”¨çš„ç‰ˆæœ¬:', versions);

            // æ¸…ç©ºç°æœ‰å†…å®¹
            elements.versionsGrid.innerHTML = '';

            // åˆ›å»ºç‰ˆæœ¬å¡ç‰‡
            versions.forEach(version => {
                const card = createVersionCard(version);
                elements.versionsGrid.appendChild(card);
            });

            console.log(`å·²åˆ›å»º ${versions.length} ä¸ªç‰ˆæœ¬å¡ç‰‡`);
        }

        // åˆ›å»ºç‰ˆæœ¬å¡ç‰‡
        function createVersionCard(version) {
            const card = document.createElement('div');
            card.className = 'version-card';
            card.setAttribute('role', 'option');
            card.setAttribute('aria-selected', 'false');
            card.setAttribute('data-version', version);

            card.innerHTML = `
                <span class="version-name">${escapeHtml(version)}</span>
                <div class="selection-indicator"></div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', () => selectVersion(version));

            return card;
        }

        // é€‰æ‹©ç‰ˆæœ¬
        function selectVersion(version) {
            if (isProcessing) return;

            // æ›´æ–°çŠ¶æ€
            selectedVersion = version;

            // æ›´æ–° UI
            updateVersionSelection(version);
            updateClaimButton();

            console.log('å·²é€‰æ‹©ç‰ˆæœ¬:', version);
        }

        // æ›´æ–°ç‰ˆæœ¬é€‰æ‹© UI
        function updateVersionSelection(selectedVersion) {
            const cards = document.querySelectorAll('.version-card');

            cards.forEach(card => {
                const version = card.getAttribute('data-version');
                const isSelected = version === selectedVersion;

                card.classList.toggle('selected', isSelected);
                card.setAttribute('aria-selected', isSelected.toString());
            });
        }

        // æ›´æ–°é¢†å–æŒ‰é’®
        function updateClaimButton() {
            const button = elements.claimButton;
            const buttonText = button.querySelector('.button-text');

            if (isProcessing) {
                button.disabled = true;
                button.classList.add('loading');
                buttonText.textContent = 'æ­£åœ¨éªŒè¯...';
            } else if (selectedVersion) {
                button.disabled = false;
                button.classList.remove('loading');
                buttonText.textContent = 'ç«‹å³å…è´¹é¢†å–';
            } else {
                button.disabled = true;
                button.classList.remove('loading');
                buttonText.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬';
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é¢†å–æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            if (elements.claimButton) {
                elements.claimButton.addEventListener('click', handleClaimClick);
            }

            // å¼¹çª—å…³é—­æŒ‰é’®
            const modalClose = document.getElementById('modalClose');
            if (modalClose) {
                modalClose.addEventListener('click', hideModal);
            }

            // å¼¹çª—èƒŒæ™¯ç‚¹å‡»å…³é—­
            const modal = document.getElementById('successModal');
            if (modal) {
                const backdrop = modal.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.addEventListener('click', hideModal);
                }
            }

            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            const copyLinkBtn = document.getElementById('copyLink');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', copyLink);
            }

            // å¤åˆ¶æå–ç æŒ‰é’®
            const copyCodeBtn = document.getElementById('copyCode');
            if (copyCodeBtn) {
                copyCodeBtn.addEventListener('click', copyCode);
            }

            // æ‰“å¼€é“¾æ¥æŒ‰é’®
            const openLinkBtn = document.getElementById('openLink');
            if (openLinkBtn) {
                openLinkBtn.addEventListener('click', openLink);
            }

            // ESC é”®å…³é—­å¼¹çª—
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    hideModal();
                }
            });
        }

        // å¤„ç†é¢†å–æŒ‰é’®ç‚¹å‡»
        async function handleClaimClick() {
            if (!selectedVersion || isProcessing) {
                return;
            }

            console.log('å¤„ç†é¢†å–è¯·æ±‚:', selectedVersion);

            // å†æ¬¡æ£€æŸ¥é™åˆ¶ï¼ˆé˜²æ­¢ç”¨æˆ·ç»•è¿‡ï¼‰
            const restriction = await checkClaimRestrictions();
            if (restriction.restricted) {
                showRestrictionNotice(restriction);
                return;
            }

            // æ·»åŠ é¢‘ç‡é™åˆ¶è®°å½•
            RestrictionManager.addClaimAttempt();

            // è®¾ç½®å¤„ç†çŠ¶æ€
            isProcessing = true;
            updateClaimButton();

            try {
                // è·å–ç”¨æˆ· IP
                const userIP = await getUserIP();

                // å°è¯•è°ƒç”¨ Supabase Edge Function
                const supabaseResult = await callSupabaseFunction(selectedVersion, userIP);

                if (supabaseResult.success) {
                    console.log('Supabase è®°å½•æˆåŠŸ:', supabaseResult);
                } else {
                    console.warn('Supabase è®°å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', supabaseResult.error);
                }

                // æœ¬åœ°æ•°æ®ç»Ÿè®¡
                const claimData = recordClaimData(selectedVersion, userIP, navigator.userAgent);

                // ä¿å­˜è®¾å¤‡é™åˆ¶ä¿¡æ¯
                StorageManager.setClaimInfo(selectedVersion, userIP);

                const versionData = VERSIONS_DATA[selectedVersion];

                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                showSuccessMessage(selectedVersion, versionData);

                console.log('é¢†å–æˆåŠŸ:', { supabaseResult, localData: claimData });

            } catch (error) {
                console.error('é¢†å–å¤„ç†å¤±è´¥:', error);
                alert('é¢†å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            } finally {
                // é‡ç½®çŠ¶æ€
                isProcessing = false;
                updateClaimButton();
            }
        }

        // è°ƒç”¨ Supabase æ•°æ®åº“ï¼ˆç›´æ¥ REST APIï¼Œé¿å… Edge Function CORS é—®é¢˜ï¼‰
        async function callSupabaseFunction(version, userIP) {
            try {
                // å°è¯•å¤šç§æ–¹å¼è·å–ç¯å¢ƒå˜é‡
                let supabaseUrl = null;
                let supabaseKey = null;

                // æ–¹æ³• 1: Vercel ç¯å¢ƒå˜é‡
                if (typeof process !== 'undefined' && process.env) {
                    supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
                    supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
                }

                // æ–¹æ³• 2: window.ENV (å¦‚æœå­˜åœ¨)
                if ((!supabaseUrl || supabaseUrl === 'YOUR_SUPABASE_URL') && window.ENV) {
                    supabaseUrl = window.ENV.SUPABASE_URL;
                    supabaseKey = window.ENV.SUPABASE_ANON_KEY;
                }

                // æ–¹æ³• 3: ç¡¬ç¼–ç ä½ çš„ Supabase é…ç½®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
                if (!supabaseUrl || supabaseUrl === 'YOUR_SUPABASE_URL') {
                    console.warn('ä½¿ç”¨ç¡¬ç¼–ç çš„ Supabase é…ç½®');
                    supabaseUrl = 'https://ddttfkymbudozwkixdyg.supabase.co';
                    supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHRma3ltYnVkb3p3a2l4ZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzMxMzMsImV4cCI6MjA4MDE0OTEzM30.yjZTQQ4b_CCTXoLrnxJZ5bdPVuPYDHhihaD1Mr7RL9s';
                }

                if (!supabaseKey) {
                    return { success: false, error: 'Supabase å¯†é’¥æœªé…ç½®' };
                }

                console.log('è°ƒç”¨ Supabase æ•°æ®åº“ï¼Œç‰ˆæœ¬:', version, 'IP:', userIP);
                console.log('Supabase URL:', supabaseUrl);
                console.log('Supabase Key length:', supabaseKey.length);

                // ç›´æ¥ä½¿ç”¨ REST API å†™å…¥æ•°æ®åº“ï¼Œé¿å… Edge Function CORS é—®é¢˜
                const claimRecord = {
                    ip_address: userIP,
                    claimed_version: version
                };

                // å¯é€‰å­—æ®µ
                if (navigator.userAgent) {
                    claimRecord.user_agent = navigator.userAgent;
                }
                const fingerprint = StorageManager.generateDeviceFingerprint();
                if (fingerprint) {
                    claimRecord.device_fingerprint = fingerprint;
                }
                const sessionId = sessionStorage.getItem('sessionId') || generateSessionId();
                if (sessionId) {
                    claimRecord.session_id = sessionId;
                }

                console.log('å†™å…¥è®°å½•åˆ° claim_records è¡¨:', claimRecord);
                console.log('JSON å­—ç¬¦ä¸²:', JSON.stringify(claimRecord));

                const response = await fetch(`${supabaseUrl}/rest/v1/claim_records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(claimRecord)
                });

                console.log('Supabase æ•°æ®åº“å“åº”çŠ¶æ€:', response.status);
                const responseText = await response.text();
                console.log('Supabase æ•°æ®åº“å“åº”å†…å®¹:', responseText);

                if (response.ok) {
                    console.log('âœ… æ•°æ®åº“å†™å…¥æˆåŠŸ');
                    // åŒæ—¶æ›´æ–°ç‰ˆæœ¬ç»Ÿè®¡
                    await updateVersionStatistics(supabaseUrl, supabaseKey, version);

                    return {
                        success: true,
                        data: {
                            message: 'æ•°æ®åº“å†™å…¥æˆåŠŸ',
                            version: version,
                            ip_address: userIP
                        }
                    };
                } else {
                    try {
                        const errorData = JSON.parse(responseText);
                        return { success: false, error: errorData, status: response.status };
                    } catch (parseError) {
                        return { success: false, error: responseText, status: response.status };
                    }
                }

            } catch (error) {
                console.error('Supabase æ•°æ®åº“è°ƒç”¨é”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        }

        // æ›´æ–°ç‰ˆæœ¬ç»Ÿè®¡
        async function updateVersionStatistics(supabaseUrl, supabaseKey, version) {
            try {
                console.log('æ›´æ–°ç‰ˆæœ¬ç»Ÿè®¡:', version);

                const today = new Date().toISOString().split('T')[0];

                // å…ˆæŸ¥è¯¢ç°æœ‰è®°å½•
                const queryResponse = await fetch(`${supabaseUrl}/rest/v1/version_statistics?version_name=eq.${version}`, {
                    method: 'GET',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (queryResponse.ok) {
                    const existingRecords = await queryResponse.json();

                    if (existingRecords.length > 0) {
                        // æ›´æ–°ç°æœ‰è®°å½•
                        const existing = existingRecords[0];
                        const claimsByDate = existing.claims_by_date || {};
                        claimsByDate[today] = (claimsByDate[today] || 0) + 1;

                        const updateResponse = await fetch(`${supabaseUrl}/rest/v1/version_statistics?id=eq.${existing.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': supabaseKey,
                                'Authorization': `Bearer ${supabaseKey}`
                            },
                            body: JSON.stringify({
                                total_claims: existing.total_claims + 1,
                                claims_by_date: claimsByDate,
                                last_claimed_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                        });

                        if (updateResponse.ok) {
                            console.log('âœ… ç‰ˆæœ¬ç»Ÿè®¡æ›´æ–°æˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ ç‰ˆæœ¬ç»Ÿè®¡æ›´æ–°å¤±è´¥:', await updateResponse.text());
                        }
                    } else {
                        // åˆ›å»ºæ–°è®°å½•
                        const createResponse = await fetch(`${supabaseUrl}/rest/v1/version_statistics`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': supabaseKey,
                                'Authorization': `Bearer ${supabaseKey}`
                            },
                            body: JSON.stringify({
                                version_name: version,
                                total_claims: 1,
                                unique_ips: 1,
                                unique_devices: 1,
                                claims_by_date: { [today]: 1 },
                                last_claimed_at: new Date().toISOString()
                            })
                        });

                        if (createResponse.ok) {
                            console.log('âœ… ç‰ˆæœ¬ç»Ÿè®¡åˆ›å»ºæˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ ç‰ˆæœ¬ç»Ÿè®¡åˆ›å»ºå¤±è´¥:', await createResponse.text());
                        }
                    }
                } else {
                    console.warn('âš ï¸ ç‰ˆæœ¬ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥:', await queryResponse.text());
                }

            } catch (error) {
                console.error('ç‰ˆæœ¬ç»Ÿè®¡æ›´æ–°é”™è¯¯:', error);
            }
        }

        // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
        function showSuccessMessage(version, versionData) {
            const modal = document.getElementById('successModal');
            const claimedVersionSpan = document.getElementById('claimedVersion');
            const linkInput = document.getElementById('linkInput');
            const extractionCodeSpan = document.getElementById('extractionCode');

            if (!modal || !claimedVersionSpan || !linkInput || !extractionCodeSpan) {
                console.error('æ‰¾ä¸åˆ°å¼¹çª—å…ƒç´ ');
                return;
            }

            // æ›´æ–°å¼¹çª—å†…å®¹
            claimedVersionSpan.textContent = version;
            linkInput.value = versionData.link;
            extractionCodeSpan.textContent = versionData.code;

            // æ˜¾ç¤ºå¼¹çª—
            modal.hidden = false;

            // è§¦å‘é‡æ’ä»¥å¯ç”¨åŠ¨ç”»
            modal.offsetHeight;

            modal.classList.add('show');

            // é˜²æ­¢é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'hidden';

            // è‡ªåŠ¨å¤åˆ¶åŠŸèƒ½
            setTimeout(() => {
                autoCopyLink(versionData.link, versionData.code);
            }, 500);

            console.log('æˆåŠŸå¼¹çª—å·²æ˜¾ç¤º');
        }

        // è‡ªåŠ¨å¤åˆ¶é“¾æ¥
        function autoCopyLink(link, code) {
            try {
                navigator.clipboard.writeText(`${link} æå–ç ï¼š${code}`)
                    .then(() => {
                        console.log('è‡ªåŠ¨å¤åˆ¶æˆåŠŸ');
                    })
                    .catch(() => {
                        console.log('è‡ªåŠ¨å¤åˆ¶å¤±è´¥');
                    });
            } catch (error) {
                console.log('è‡ªåŠ¨å¤åˆ¶å‡ºé”™:', error);
            }
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const linkInput = document.getElementById('linkInput');
            if (!linkInput) return;

            const link = linkInput.value;

            navigator.clipboard.writeText(link)
                .then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶ï¼');
                })
                .catch(() => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
        }

        // å¤åˆ¶æå–ç 
        function copyCode() {
            navigator.clipboard.writeText('talk')
                .then(() => {
                    alert('æå–ç å·²å¤åˆ¶ï¼');
                })
                .catch(() => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼štalk');
                });
        }

        // æ‰“å¼€é“¾æ¥
        function openLink() {
            const linkInput = document.getElementById('linkInput');
            if (!linkInput) return;

            const link = linkInput.value;
            window.open(link, '_blank', 'noopener,noreferrer');
        }

        // å…³é—­å¼¹çª—
        function hideModal() {
            const modal = document.getElementById('successModal');
            if (!modal) return;

            modal.classList.remove('show');

            setTimeout(() => {
                modal.hidden = true;
                document.body.style.overflow = '';
            }, 300);
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('JavaScript é”™è¯¯:', event.error);
        });
    </script>
</body>
</html>
